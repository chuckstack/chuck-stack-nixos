# chuck-stack-nix

The purpose of this repository is to provide nixos configuration files to quickly assemble a working chuck-stack.

For more information, go to the [chuck-stack](https://chuck-stack.org).

## Nix Configurations

You can use the below files like a menu of services. Chose the options you wish to install on a given server using the below instructions.

- system.nix - installs all the tools one might expect to manage a server.
- postgresql.nix - installs PostgreSQL with minimal configuration
- user.nix - provides example 'real' and 'system' users
- stk-app.nix - represents the most simple version of a chuck-stack application
  - configures PostgreSQL to contain a specific database
  - creates a service to run [migrations](https://github.com/chuckstack/stk-app-sql)
  - creates a PostgREST user named: postgrest
  - configures PostgREST and runs it as a service
- nginx.nix - installs and configures nginx for publishing a static and providing a reverse proxy for PostgREST
- [more...](./nixos/)

## First Thing to Do

This section assumes you are connecting to a new NixOS instance. The below bash code snippet does the following:

1. install the tools to make your first changes to /etc/nixos/configuration.nix
1. clones this repository in /etc/nixos/chuck-stack-nix/
1. updates configuration.nix to include the appropriate nix configuration files
1. exits out of the nix-shell so that when you nixos-rebuild, you get the latest tools.

Note: since a new instance of NixOS has few tools installed by default, you can use nix-shell to temporarily install git, neovim and tmux (and anything else you wish to use temporarily).

```bash
tmux # create a session that remains even if you get disconnected
nix-shell --packages git neovim tmux
cd /etc/nixos/
git clone https://github.com/chuckstack/chuck-stack-nix.git
nvim configuration.nix #make below changes
exit # exit nix-shell
```
## Configuration.nix

The chuck-stack-nix repository creates a nixos menu of services. You simply include the services you want in your /etc/nixos/configuration.nix file.

Here is an example configuration.nix file. Notice the lines ending in '# here'. They represent the lines you might want to add to your configuration.

```nix
...
  imports = [
    # Include the default incus configuration.
    "${modulesPath}/virtualisation/incus-virtual-machine.nix"
    # Include the container-specific autogenerated configuration.
    ./incus.nix
    ./chuck-stack-nix/nixos/system.nix  # here
    ./chuck-stack-nix/nixos/postgresql.nix  # here
    ./chuck-stack-nix/nixos/user.nix  # here
    ./chuck-stack-nix/nixos/stk-app.nix  # here
    ./chuck-stack-nix/nixos/nginx.nix  # here
    #./chuck-stack-nix/nixos/nginx-fail2ban.nix  # here if needed
    #./chuck-stack-nix/nixos/cloudflared.nix # here if needed
    ];
...
```

### NixOS Actions Needed

Some of the services require configuration before using. Perform the following to quickly see all "# Action..." in all files:

```bash
grep -rni -C10 "Action:" /etc/nixos/chuck-stack-nix/nixos
```

To look for a specific action with a specific keyword somewhere in the same line:

```bash
grep -rni -C10 "Action:.*keyword" /etc/nixos/chuck-stack-nix/nixos

```

Note: -C10 shows the previous and following 10 lines

### Rebuild

To rebuild with the new configuration:
```
nixos-rebuild switch
```
If you exit from your session then reconnect, your bash session will be updated with all the new tools and features.

## NixOS Examples

Nix is both powerful and capable as well as complex. We have tried to be consistent in how we do things. One way to promote consistency is to highlight example of how to do things.

When looking for examples, always start in ./chuck-stack-nix/nixos/system.nix. It represents the most basic starting place to configure your system.

Perform the following to quickly see all "# Example..." in all files:

```bash
grep -rni -A10 "Example:" /etc/nixos/chuck-stack-nix/nixos
```

To look for a specific example with a specific keyword somewhere in the same line:

```bash
grep -rni -C10 "Example:.*keyword" /etc/nixos/chuck-stack-nix/nixos

```

Note: -A10 shows the following (after) 10 lines

## PostgreSQL psql Connection

This section helps you connect to your newly created chuck-stack database. Here are important details to know:

- The database is configured to listen to unix socket connects from local users.
- The stk-app.nix configuration creates a 'stk_superuser' in both the database and nixos.

To connect to the database (assuming you starting from the nixos root user):

```bash
# > root
su - stk_superuser
```

```bash
# > stk_superuser
psql -d stk_db
```

## SSH Details

SSH is disabled by default in system.nix. Uncomment the system.nix => services.openssh section if you wish to enable it. The reasons it is disabled by default are:

- It is safer to assume you do not want it enabled and open.
- The NixOS default behavior is to open the ssh port firewall port when the ssh service is enagbled. To prevent this, you must explicitly disable the port in the system.nix => networking.firewall section.
- The Incus command `incus exec instance-name bash` does not use ssh to connect; therefore, you can connect from Incus without needing the sshd services enabled.

## Network Static IP

If you wish to expose an instance to the outside world from an Incus cluster, execute the following assuming your external IP is x.x.x.x/32.

```bash
# from incus cli
incus config device override incus-isntance-name eth0 ipv4.routes.external=x.x.x.x/32
```

Inside your container's /etc/nixos/configuration.nix, update the systemd.network => networks => networkConfig accordingly:
```nix
...
      networkConfig = {
        Address = "x.x.x.x/32";
        DHCP = "yes";
        IPv6AcceptRA = true;
      };
...
```
If you run `ip a`, you should see an internal IP and the above x.x.x.x/32 external IP.

## Managing Key-Value Pairs in NixOS with File Permissions

The most simple and standard way to handle key-value pairs in NixOS while restricting visibility is to use a separate Nix file with restricted file permissions. Note this topic does not involve/include encryption.

### Step 1: Create a secrets file

To create isolation from the nix store, place the secrets file in a separate directory with restricted permissions:

```bash
sudo mkdir -p /etc/chuck-stack/secrets
sudo chmod 700 /etc/chuck-stack/secrets
sudo touch /etc/chuck-stack/secrets/keys.nix
sudo chmod 600 /etc/chuck-stack/secrets/keys.nix
sudo chown root:root /etc/chuck-stack/secrets/keys.nix
```

```nix
# /etc/chuck-stack/secrets/keys.nix
{
  apiKey = "your-api-key";
  dbPassword = "your-db-password";
  # other key-value pairs
}
```

### Step 2: Import in your configuration

Here is an example:

```nix
# /etc/nixos/configuration.nix
{ config, pkgs, ... }:

let
  secrets = import /etc/chuck-stack/secrets/keys.nix;
in {
  # Now use the values as needed
  services.someService.apiKey = secrets.apiKey;
  services.database.password = secrets.dbPassword;
}
```

Here is another example copied in part from [cloudflared.nix](./nixos/cloudflared.nix):

```nix
{ config, lib, pkgs, modulesPath, ... }:

let
  # Import secrets here
  secrets = import /etc/chuck-stack/secrets/keys.nix;
in {
  environment.systemPackages = with pkgs; [
    cloudflared
  ];

  #... Lines omitted for brevity

  systemd.services.my_tunnel = {
    wantedBy = [ "multi-user.target" ];
    after = [ "network-online.target" "systemd-resolved.service" ];
    requires = [ "network-online.target" ];
    serviceConfig = {
      # Use secret here
      ExecStart = "${pkgs.cloudflared}/bin/cloudflared tunnel --no-autoupdate run --token=${secrets.cloudflaredToken}";
      Restart = "always";
      User = "cloudflared";
      Group = "cloudflared";
    };
  };
}
```

### Important Note

Be aware that this approach only protects the file from being read directly. For true security, you would need encryption-based tools like `agenix` or `sops-nix`.

##  Other Notes

Each Nix file has a section at the top for notes about the configuration and its usage
